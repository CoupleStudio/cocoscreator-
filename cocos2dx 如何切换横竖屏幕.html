<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.11 (454874)"/><meta name="keywords" content="横竖屏切换"/><meta name="altitude" content="45"/><meta name="author" content="xiayangqun"/><meta name="created" content="2017-08-16 07:39:38 +0000"/><meta name="latitude" content="40.09614455643049"/><meta name="longitude" content="116.2805733101728"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-08-16 09:44:05 +0000"/><title>cocos2dx 如何切换横竖屏幕</title></head><body><div>       作为一个写了三年多Cocos的(cai)大(bi)神,从C++到lquick到Cocos-js再到现在的CocosCreator，也算是各种语言都写了一遭。对于现在的CocosCreator(下文简称CCC),从刚开始出现之时的质疑，“这玩意不是完全照抄Unity吗”。到用了一段时间之后，发现开发效率确实比以前提高了不少。总的来说，觉得CCC的未来一定是大有可为的。但是这其中有个比较致命的问题，就是CCC把底层封装成JS和组件暴露给开发者之后，能理解cocos底层的人将会越来越少，将来很多没有从C++走过来的人可能对cocos只能知其然，而不能知其所以然。更不要说Hank一些代码来满足自己的需求啦。比如说，今天这篇文章将要讲述的如何切换横竖屏的问题。</div><div>      本教程所使用的版本为CCC的1.4.2版本，不同版本的代码可能会有所差异，所以，本次教程不会机械的上去贴代码，而是一步步深入分析问题，从而引导出我们想要的结果。阅读本文之前希望读者有开发过cocos-2dx 和 cocos-js的基础，但是即使没有，也不会影响接下来阅读。本文章是完全面向新手的，我会尽量的将每个知识点都阐述的简明易懂。</div><div>     首先我们先阐述一下几个基本概念.</div><div><span>    <b>1.屏幕的画布分辨率:</b><b>    frameSize</b></span><br/></div><div><span><b>   </b> frameSize是屏幕的真实的分辨率，比如说一个iphone5s，在横屏的时候那么它的画布分辨率就是 1136 x 640,而在竖直的情况下<br/></span></div><div>一定是 640 x 1136。这是固定的永远都不会变的。这点很关键。在cocos中得到frameSize的   api 一般是  xxx.getFrameSize(); 这个</div><div>xxx到底是个啥，不同的语言有不同的调用方法，但是看到 getFrameSize()这个东西，我们就要意识到这个是得到屏幕的画布分辨率，</div><div>同理  xxxx.setFrameSize()就是设置咯。</div><div><span><span><span><span><span>    </span></span></span></span></span></div><div><span><span><span>    <b>2.在CCC中创建2个Scene</b></span></span></span></div><div><span><span><span><span><span>    sceneH 是一个横向的屏幕，我给它的四个角都加了一张精灵来标示屏幕的位置，屏幕上所有的元素都挂载了widget组件</span></span></span></span></span></div><div>    <img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/5B8B2AB2-E233-48BC-8C8C-028D7DFDF5EF.png" height="440" width="750"/></div><div><span><span><span>    他的设计设计分辨率如下：</span></span></span></div><div>    <img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/541FD8A0-8568-4D56-9C3D-F066E22E6812.png" height="155" width="469"/></div><div><br/></div><div><span>    sceneV 是一个竖直方向的场景，他的设置如下。</span><br/></div><div>    <img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/3C8B2D02-DDE2-4BC3-960F-967E8BBDEF55.png" height="443" width="272"/><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/9869A5C6-85C8-4ABB-8B68-D805A833A6E6.png" height="157" width="452"/></div><div><span><span>    </span><br/></span></div><div><span><span><span>   每次点击“切换屏幕”按钮之后，我们就会首先会调用一个函数，把屏幕设置成竖屏还是横屏，接下，转跳到对面的Scene上</span><br/></span></span></div><div><span><span><span><span>   我们可以看到每个屏幕上都有label，这里，我们会显示一下屏幕的基本信息。</span><br/></span></span></span></div><div>...</div><div><span>start</span><span>:</span><span style="font-weight: bold;">function </span><span>() {</span></div><div><span>    </span><span style="font-weight: bold;">var </span><span>string1   = </span><span>'visibleSize: '</span><span>+ cc.visibleRect.</span><span>width</span><span>.</span><span>toFixed</span><span>(</span><span>2</span><span>) + </span><span>'-' </span><span>+ cc.visibleRect.</span><span>height</span><span>.</span><span>toFixed</span><span>(</span><span>2</span><span>)</span><span>;</span><span>    </span></div><div><span style="font-weight: bold;"><span>    </span>var </span><span>string2   = </span><span>'designSize:' </span><span>+ cc.</span><span style="font-style: italic;">view</span><span>.</span><span>getDesignResolutionSize</span><span>().</span><span>width </span><span>+ </span><span>'-'</span><span>+ cc.</span><span style="font-style: italic;">view</span><span>.</span><span>getDesignResolutionSize</span><span>().</span><span>height</span><span>;</span><span>    </span></div><div><span style="font-weight: bold;"><span>    </span>var </span><span>string3   = </span><span>'frameSize:'</span><span>+ cc.</span><span style="font-style: italic;">view</span><span>.</span><span>getFrameSize</span><span>().</span><span>width</span><span>+</span><span>'-'</span><span>+cc.</span><span style="font-style: italic;">view</span><span>.</span><span>getFrameSize</span><span>().</span><span>height</span><span>;</span><br/><span>    </span><span style="font-weight: bold;">this</span><span>.</span><span>viewLabel</span><span>.</span><span>string </span><span>= string1 + </span><span>'</span><span>\n</span><span>' </span><span>+ string2+</span><span>'</span><span>\n</span><span>'</span><span>+string3</span><span>;</span><span>    </span><span>cc.</span><span>log</span><span>(</span><span style="font-weight: bold;">this</span><span>.</span><span>viewLabel</span><span>.</span><span>string</span><span>)</span><span>;</span></div><div><span>}</span><span>,</span></div><div>…</div><div>代码如上，我们在Start函数里显示了当前屏幕的的基本信息。</div><div><br/></div><div><b>3.开始写实现屏幕反转的函数，创建JsNativeBridget.js文件 并且设置这个文件为插件</b></div><div><span>window.</span><span>JsNativeBridge </span><span>= {</span></div><div><span>    </span><span>// true 是切换到横屏， false 是切换到竖屏</span><br/><span>    </span><span>changeOrientationH</span><span>:</span><span style="font-weight: bold;">function </span><span>(val</span><span>) {</span></div><div><span>        </span><span style="font-weight: bold;">if</span><span>(cc.sys.</span><span>isBrowser</span><span>){</span></div><div><span>            </span><span style="font-weight: bold;">var </span><span>frameSize = cc.</span><span style="font-style: italic;">view</span><span>.</span><span>getFrameSize</span><span>()</span><span>;</span><span>           </span></div><div><span/><span><span>    <span>    <span>    </span></span></span>cc.</span><span style="font-style: italic;">view</span><span>.</span><span>setFrameSize</span><span>(frameSize.</span><span>height</span><span>,</span><span>frameSize.</span><span>width</span><span>)</span><span>;</span><span>        </span></div><div><span><span>    <span>    </span></span>}</span></div><div><span>        </span><span style="font-weight: bold;">else</span><span>{</span></div><div><span>            </span><span style="font-weight: bold;">if</span><span>(cc.sys.</span><span>os </span><span>== cc.sys.</span><span>OS_IOS</span><span>){</span></div><div><span>                jsb.</span><span>reflection</span><span>.</span><span>callStaticMethod</span><span>(</span></div><div><span>                   </span><span>"AppController"</span><span>,</span><span>                   </span></div><div><span/><span><span>    <span>    <span>    <span>    <span>    </span></span></span></span></span>"changeOrientationH:"</span><span>,</span><span>                    </span></div><div><span><span>    <span>    <span>    <span>    <span>    </span></span></span></span></span>val</span> );            </div><div><span><span>    <span>    <span>    </span></span></span>}</span></div><div><span>            </span><span style="font-weight: bold;">else if</span><span>(cc.sys.</span><span>os </span><span>== cc.sys.</span><span>OS_ANDROID</span><span>){</span></div><div><span>                jsb.</span><span>reflection</span><span>.</span><span>callStaticMethod</span><span>(</span></div><div><span>                    </span><span>"org/cocos2dx/javascript/AppActivity"</span><span>,</span><span>                    </span></div><div><span>                     "changeOrientationH"</span><span>,</span><span>                    </span></div><div><span>                    "(Z)V"</span><span>,</span><span>                   </span></div><div><span/><span>                     val</span> );          </div><div><span>    <span>     </span></span>  }</div><div><span>        }</span></div><div><span>    </span><span>}</span><span>,</span></div><div><span><br/></span></div><div><span>  <b><font style="font-size: 24px;">  </font><font style="font-size: 24px;">web:在web环境下为了方便，我们日常的开发，我们可以直接获取到当前的frameSize，然后让他们互换一下就好啦</font></b></span></div><div><font style="font-size: 24px;"><b>代码如下，实现起来真是美滋滋呢。</b></font></div><div>     <span>    <span>   </span></span><span style="font-weight: bold;">var </span>frameSize = cc.<span style="font-style: italic;">view</span>.getFrameSize();           </div><div>            cc.<span style="font-style: italic;">view</span>.setFrameSize(frameSize.height,frameSize.width);</div><div><br/></div><div><span><font style="font-size: 24px;"><b>    ios: 因为IOS平台上OC和C++ 可以混编，而且还没有不同线程之间通信的问题，所以我们先来搞定IOS吧。记得要先构建发布Native端工程才行啊</b></font></span></div><div><span><span>    写过C++代码的同学应该对于cocos的渲染有所了解, cocos的Director持有一个openGlVIew对象，cocos的所有渲染都是靠着这个openGL来渲染，</span></span></div><div>相信大家对于这段代码不会陌生。</div><div><br/></div><div>    <img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/7BC6231E-AEF2-4346-B7C6-0D2029F0DFAF.png" height="407" width="1010"/></div><div><span><br/></span></div><div>但是这个openGLView到底是如何渲染的呢，我们打开Xcode工程，打开ios文件夹下的AppController.mm.</div><div><span style=""><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/0E26925A-F4E8-4020-A928-DA5992222132.png" height="519" width="1063"/></span></div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/6E1175B4-6F8A-4130-A601-00CC5403F05D.png" height="561" width="908"/><br/></div><div><br/></div><div><span>    对于IOS原生应用稍微了解一点的同学都知道，IOS的展示是靠着一个个的ViewController来实现的，这里的view跟cocos的Scene非常似，比如说</span>我们的QQ从登陆到进入好友列表，可能就是从登陆的view切换到好友的view一样，这段代码里我们可以看到，引擎创建了一CCEAGLVIew的对象，并且将这个对象放到了一个rootView上。然后将这个对象包裹成一个 cocos2d:GLView ，然后再将它交给我们director，然后我们的cocos程序就启动起来啦。</div><div><span>    所以在IOS上想要切换屏幕的横竖屏，其实我们要做的就是切换IOS原生的view的横竖屏。而且，正常的cocos应用在IOS里只有一个view，这个view就</span>是用来承载渲染的opglView的view，我们游戏里的Scene不管怎么切换，也一直是在这一个view上渲染的。所以我们就找这个view下手就对了。</div><div><span>    在IOS里，想要切换一个view的横竖屏应该是有接口的，毕竟这是一个很常见的需求，但是自从IOS8之后，苹果爸爸不再建议开发者这么干了，希望大家</span>根据重力感应自由的让屏幕旋转来切换横竖屏的，当然在游戏大厅了。麻将就是竖屏，而打飞机一定就是横屏，这可不是靠着重力来的，所以，我们需要第二个解决方案，那就是创建第二个view，本来存在的第一个view是固定的横屏幕。而第二个view是固定的竖屏幕。我们需要什么方向的，就让那个方向的view显示，同时把CCEAGLVIew在2个view之间相互转移，谁显示就转移到谁的身上。</div><div><span>    </span><br/></div><div>我们打开 RootViewController.mm观察这三个函数，<br/></div><div><span><span><span>   </span>第一个允许屏幕的方向是  左横屏和右横屏，</span><br/></span></div><div><span><span><span>  </span><br/></span></span></div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/614045D3-8966-4DFD-A7C4-1340C8E47421.png" height="376" width="956"/><br/></div><div><span>    </span></div><div><span><br/></span></div><div><span>接下来我们创建第二个View ，在这个view里我们允许view显示的方向为竖直方向</span></div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/98C51F5D-8C5F-421B-8E56-CB008749B901.png" height="50" width="238"/><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/C84F42A7-C309-466B-A489-656D438F2B00.png" height="282" width="620"/><br/></div><div><br/></div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/3E57E3F3-E13D-47B2-8857-DEC87C6AC193.png" height="579" width="899"/><br/></div><div><br/></div><div>在这里。我们允许了屏幕展示的方向总共有三种，所以Info.plist里也不要忘记构选上相应的方向哦</div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/C674CE73-FBF7-42B6-81D1-DEBB66AAE848.png" height="148" width="500"/><br/></div><div><br/></div><div><br/></div><div><br/></div><div>接下来就是实现我们的函数啦。</div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/EC247E14-4423-4297-942C-F4D3EC61C207.png" height="62" width="132"/><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/720390B2-BC5C-426C-B84C-88CA1F2C3577.png" height="337" width="1198"/><br/></div><div><br/></div><div><br/></div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/11ED9E6C-CD34-4F82-B540-D8C7D8A6D03B.png" height="366" width="1011"/><br/></div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/D23B7384-E936-4DFA-850F-26E30D599420.png" height="623" width="1182"/><br/></div><div>在AppController.mm里加入如上的代码，</div><div><br/></div><div>然后我们实现  +(void)changeOrientationH:(BOOL)val 函数</div><div> <img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/9B8C1642-78EE-4A9C-8EDA-4D33EA7EA691.png" height="622" width="697"/></div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/95A7BC97-CF7C-4700-B044-364D1F66F745.png" height="492" width="1003"/><br/></div><div><br/></div><div>这就是是整个函数的实现， 在这里的话，一开始，我们发现屏幕确实从横屏旋转成了竖屏幕，但是竖直屏幕的Scene的frameSize仍旧是横屏的  1136 x 640。原来我们切换了方向之后，CCEGLView的frameSize确实发生了变化，但是director的opglView的frameSize还是老的，没有变化，所以，红框里的代码很重要。</div><div>其实opglView的frameSize就是在  <img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/9633F409-7B5A-48EF-A42B-F68B8A688ED4.png" height="45" width="768"/></div><div>这句代码里根据eaglView的 分辨率来设置的，感谢兴趣的同学可以点进去看看。这里不再多费笔墨了。</div><div><br/></div><div><br/></div><div><font style="font-size: 24px;"><b>填完了IOS的坑，我们再来趟android的水吧，</b></font></div><div>通过刚才对IOS底层的探索，我们对付起来android会更加的得心应手，其实android也有个叫activity的东西，cocos也是把opgelVIew放在一个固定的activey上渲染，所以我们只需要1.旋转activey 。2.改变direct的opglView的frameSize。</div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/C8A086D0-9524-49AF-ABD6-F70F4802D293.png" height="307" width="1075"/><br/></div><div><br/></div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/79FDE480-751B-4F11-BD79-DB2C2EF5E89B.png" height="295" width="1094"/><br/></div><div>相对IOS来说， android的代码要少很多,但是说好的 把opgelVIew放到activity上呢？？在 onCreate函数里根本啥子都没有啊。不要急，我们点看AppActivity的父类 Cocos2dxActivity进去看一看。</div><div><br/></div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/EB7D4A07-F89B-4BF9-B166-965C8285A376.png" height="756" width="957"/><br/></div><div>这个init()看着似乎很可疑，我们再点进去看看。</div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/42672D22-03B4-43AF-8CA8-E576104F34A8.png" height="858" width="910"/><br/></div><div><br/></div><div>哈 surfaceView是什么鬼？？你是opglView的表哥吗？？ 等等，这个cocos2dxRenderer()不就是渲染的意思吗。666，我们进去这2个Java文件里看看有什么可以的地方吗？</div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/A6E0EA35-ED7F-4D0E-ABAE-88926209062D.png" height="121" width="994"/><br/></div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/4B946E66-D68B-4F54-B592-4157D7607A35.png" height="39" width="962"/><br/></div><div>功夫不负有心人，我们终于找到了这个奇怪的函数，貌似是当屏幕变化的时候会触发。经过打断点验证，每次，我点击屏幕选择的时候，都会触发这个函数，燃而且传入的width和 height都是正确的屏幕旋转了之后的值。我们来看看这个nativeOnSurfaceChangedC++层是怎么实现它的。</div><div>在cocos2d-x/cocos/platform/android/javaactivity-android.cpp里有这个函数的实现</div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/3EC7A0C8-F4FD-432C-80BC-0AD0E4A14231.png" height="114" width="996"/><br/></div><div>一时语塞，我们再在同级的目录下找到了 CCApplication-android.cpp里找到了 applicationScreenSizeChanged这个函数，里边居然是空的，厉害了，我的哥，</div><div>正好在C++层，所以我们来写点代码吧</div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/6FFC10CD-B69D-4C35-876F-647432EDEBE8.png" height="89" width="830"/><br/></div><div>这下子，妥妥没问题了，跑起来，跑起来，屏幕是旋转了，但是还是frameSize还没有变化。此时的我机智的想到了多线程的问题，毕竟安卓的多线程比较容易坑到人，所以要留意下，</div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/6783A77E-0ABD-4947-BD5C-64EEE0B3787F.png" height="865" width="750"/><br/></div><div>重新改早一下函数，加入旋转之后的回调，旋转之后延迟 0.5秒再进行回调，在回调里转跳Scene，再次试验，搞定了。</div><div><br/></div><div>最后一个问题，<span style="font-weight: bold;">applicationScreenSizeChanged</span>在安卓里会触发，在IOS里会触发吗，我们找到了cocos2d-x/cocos/platform/ios/CCApplication-ios.mm进去看看，发现这也是个空函数，拿他什么时候会触发呢？？我们打开RootViewController.mm里看到这个函数 </div><div><img src="cocos2dx%20%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E6%A8%AA%E7%AB%96%E5%B1%8F%E5%B9%95.resources/D29371F1-FF48-439F-9209-5936CDE125E3.png" height="396" width="974"/><br/></div><div>这个<b>didRotateFromInterfaceOrientation</b>触发的条件的貌似是 同一个view在旋转之后触发，我们因为是2个view来回切换，所有并不会触发这个函数，自然也没法在这个空函数里改变frameSize啦</div></body></html>